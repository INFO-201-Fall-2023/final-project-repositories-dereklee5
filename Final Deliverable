#Final Project: Final Deliverable
library(dplyr)
library(stringr)
library(ggplot2)
library(shiny)
library(plotly)

source("data_cleaning.R")
df <- read.csv("Final_Clean_DF.csv")
map_data <- map_data('world')

intro_pg <- tabPanel("Introduction",
                     h1("Analyzing the Change in Ocean Conditions with the Decline in Mental Wellbeing Across the World"),
                     br(),
                     p("Context: A plethora of negative effects have been identified as a result of ocean temperatures continuing to rise due to 
                       climate change. Warming seawater causes ice to melt in polar regions and rises in sea levels, intensifying catastrophic events such as 
                       cyclones, landslides, fatal storms, and flooding while also harming human populations. Aside from the negative changes in ocean water quality, 
                       the United States has seen a significant surge in mental health disorders across the country. More Americans than ever before have expressed feelings of 
                       social isolation and loneliness, which were exacerbated by the COVID-19 pandemic. This growth in mental health disorders is concerning and threatens the 
                       well-being and vitality of millions of Americans."),
                     br(),
                     p("We believe that our research will shed light on the influence that changing ocean water conditions and climate change can have on Americans' mental health. 
                       We intend to answer the topic of how one's environment might dictate and influence one's mental well-being by studying the association between changing ocean 
                       water conditions and increasing mental health disorders across the United States over time. Our unique analysis takes an intriguing approach to treating mental 
                       health difficulties by assessing their environmental roots and how they influence individuals in their daily lives, encouraging more people to take action and address 
                       the destructive nature of these two diseases."),
                     br(),
                     p("Datasets + Analysis"),
                     br(),
                     p("Conclusion")
)
summary_pg <- tabPanel("Summary",
                       h1("Summary Takeaways and About Us"),
                       br(),
                       p("Through our data analysis, it is evident that climate change impacting ocean conditions has an detrimental impact on peopleâ€™s mental wellbeing across the world. It is imperative that experts continue to conduct research on this matter in order to improve the health of the earth as well as the mental health of individuals all across the globe. ")
)


controls <- sidebarPanel(
  h1("Control Panel"),
  selectInput(
    inputId = "data_type",
    label = "Select a Category:",
    choices = filter_choice_df$filter_choices
  ),
  selectInput(
    inputId = "second_type",
    label = "Select a Second Category:",
    choices = filter_choice_df$filter_choices
  )
)
view_05 <- tabPanel("2005", plotOutput(outputId = "barchart_5"))
view_18 <- tabPanel("2018", plotOutput(outputId = "barchart_18"))
both_view <- tabPanel("2005-2018", h3("Change between 2005 and 2018"), plotOutput(outputId = "linechart"))
viz_pg_1 <- tabPanel("Change Over Time",
                     fluidPage(
                       titlePanel("Comparing Ocean Conditions and Mental Wellbeing Over Time"),
                       sidebarLayout(
                         controls,
                         mainPanel(
                           tabsetPanel(
                             view_05,
                             view_18,
                             both_view
                           )
                         )
                       )
                     )
)

controls_year <- sidebarPanel(
  h1("Control Panel"),
  selectInput(
    inputId = "year",
    label = "Select a Year",
    choice = unique(df$Year)
  )
)

plot_view <- tabPanel("Plot", plotOutput(outputId = "contrast_map"))
main_viz_3 <- mainPanel(
  tabsetPanel(plot_view)
)

viz_pg_3 <- tabPanel("Contrasts",
                       fluidPage(
                         titlePanel("Contrasts Data Story"),
                         sidebarLayout(controls_year, main_viz_3)
                       )
)

ui <- navbarPage("Final Deliverable",
                 intro_pg,
                 viz_pg_1,
                 #viz_pg_2,
                 viz_pg_3,
                 summary_pg
)

server <- function(input, output){
  output$barchart_5 <- renderPlot({
    if(input$data_type == "All" && input$second_type == "All") {
      data_cat <- data_05
    } else if(input$data_type == "All") {
      data_cat <- filter(data_05, Categories == input$second_type)
    } else if (input$second_type == "All") {
      data_cat <- filter(data_05, Categories == input$data_type)
    } else {
      data_cat <- filter(data_05, Categories == input$data_type | Categories == input$second_type)
    }
    p <- ggplot(data_cat, aes(x = Categories, y = V1, fill = Categories)) + geom_bar(stat = "identity") + labs(x = "Variables", y = "Values", fill = "Variables")
    return(p)
  })
  output$barchart_18 <- renderPlot({
    if(input$data_type == "All" && input$second_type == "All") {
      data_cat <- data_18
    } else if(input$data_type == "All") {
      data_cat <- filter(data_18, Categories == input$second_type)
    } else if (input$second_type == "All") {
      data_cat <- filter(data_18, Categories == input$data_type)
    } else {
      data_cat <- filter(data_18, Categories == input$data_type | Categories == input$second_type)
    }
    a <- ggplot(data_cat, aes(x = Categories, y = V1, fill = Categories)) + geom_bar(stat = "identity") + labs(x = "Variables", y = "Values", fill = "Variables")
    return(a)
  })
  output$linechart <- renderPlot({
    df_long <- tidyr::gather(avg_df, key = "Variable", value = "Value", -Year)
    if(input$data_type == "All" && input$second_type == "All") {
      data_cat <- df_long
    } else if(input$data_type == "All") {
      data_cat <- filter(df_long, Variable == input$second_type)
    } else if (input$second_type == "All") {
      data_cat <- filter(df_long, Variable == input$data_type)
    } else {
      data_cat <- filter(df_long, Variable == input$data_type | Variable == input$second_type)
    }
    b <- ggplot(data_cat, aes(x = Year, y = Value, color = Variable)) +
      geom_line()
    return(b)
  })
  
  output$contrast_map <- renderPlot({
    year_df <- filter(df, Year == input$year)
    quartile <- round(nrow(year_df) / 4)
    high <- year_df[order(year_df$Life.Ladder, decreasing = T), ][1:quartile, ]
    low <- year_df[order(year_df$Life.Ladder), ][1:quartile, ]
    
    h_df <- left_join(high, map_data, by=c('Country.Name' = 'region'))
    l_df <- left_join(low, map_data, by=c('Country.Name' = 'region'))
    
    p <- ggplot() +
      geom_polygon(data = map_data("world"),
                   aes(x=long, y=lat, group = group),
                   color = 'darkgrey', fill = 'lightgrey') +
      geom_polygon(data = h_df,
                   aes(x=long, y=lat, group = group,
                       fill = 'Upper Quartile')) +
      geom_polygon(data = l_df,
                   aes(x=long, y=lat, group = group,
                       fill = 'Lower Quartile')) +
      ggtitle(paste("Lower and Upper Quartile Life Ladder Score Countries in",
                    input$year)) +
      guides(fill=guide_legend(title="Colors")) +
      scale_fill_manual(values = c('Upper Quartile' = 'royalblue', 'Lower Quartile' = 'firebrick'))
    
    return(p)
  })
}


shinyApp(ui = ui, server = server)
